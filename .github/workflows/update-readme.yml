name: Update README from source repos

on:
  repository_dispatch:
    types: [readme-updated]
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name to sync'
        required: true
        type: choice
        options:
          - PLC_BACKEND
          - Brain_ETL
          - BACKEND_NEXUS
          - FRONTEND
          - Mybrainsuite

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout documentation repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      - name: Get repository info
        id: repo_info
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "repo_name=${{ github.event.client_payload.repo_name }}" >> $GITHUB_OUTPUT
            echo "readme_url=${{ github.event.client_payload.readme_url }}" >> $GITHUB_OUTPUT
          else
            REPO_NAME="${{ github.event.inputs.repo_name }}"
            echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
            echo "readme_url=https://raw.githubusercontent.com/luisrodriguezlopez96/$REPO_NAME/main/README.md" >> $GITHUB_OUTPUT
          fi
      
      - name: Download README
        run: |
          mkdir -p docs/repositories
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -o "docs/repositories/${{ steps.repo_info.outputs.repo_name }}.md" \
               "${{ steps.repo_info.outputs.readme_url }}"
      
      - name: Add metadata header
        run: |
          REPO_NAME="${{ steps.repo_info.outputs.repo_name }}"
          FILE="docs/repositories/$REPO_NAME.md"
          
          # Crear header con metadata
          cat > temp_header.md << EOF
          ---
          source_repo: luisrodriguezlopez96/$REPO_NAME
          last_synced: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          sync_commit: ${{ github.event.client_payload.commit_sha || 'manual' }}
          ---

          > ðŸ“Œ **Nota:** Esta documentaciÃ³n se sincroniza automÃ¡ticamente desde [\`$REPO_NAME\`](https://github.com/luisrodriguezlopez96/$REPO_NAME)

          EOF
          
          # Combinar header con README
          cat temp_header.md "$FILE" > temp_combined.md
          mv temp_combined.md "$FILE"
          rm temp_header.md
      
      - name: Commit and push if changed
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add docs/repositories/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            REPO_NAME="${{ steps.repo_info.outputs.repo_name }}"
            COMMIT_MSG="${{ github.event.client_payload.commit_message }}"
            
            if [ -n "$COMMIT_MSG" ]; then
              git commit -m "docs: sync $REPO_NAME README" -m "Original commit: $COMMIT_MSG"
            else
              git commit -m "docs: sync $REPO_NAME README (manual trigger)"
            fi
            
            git push
          fi
      
      - name: Notify completion
        if: success()
        run: |
          echo "âœ… README from ${{ steps.repo_info.outputs.repo_name }} synced successfully"
